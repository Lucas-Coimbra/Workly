generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ======================
 * ENUMS
 * ======================
 */

enum Role {
  MEMBER
  ADMIN
  SUPPORT
}

enum SpaceRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OwnerType {
  individual
  company
}

enum SupportTicketStatus {
  open
  progress
  resolved
}

enum SupportPriority {
  low
  medium
  high
}

/**
 * ======================
 * MODELS
 * ======================
 */

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  phone     String?
  password  String
  role      Role     @default(MEMBER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  planId Int?
  plan   Plan? @relation(fields: [planId], references: [id])

  reservations        Reservation[]
  notifications       Notification[]
  passwordResetTokens PasswordResetToken[]
  supportTickets      SupportTicket[]
  supportMessages     SupportMessage[]

  reviewedSpaceRequests SpaceRequest[] @relation("ReviewedByAdmin")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model Plan {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  price        Float
  monthlyHours Int
  createdAt    DateTime @default(now())

  users User[]
}

model Workspace {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  email       String
  phone       String?
  address     String

  zipCode      String?
  street       String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?

  totalArea       Int?
  capacity        Int?
  totalRooms      Int?
  pricePerHour    Float?
  pricePerDay     Float?
  pricePerMonth   Float?
  minimumBooking  Int?
  additionalInfo  String?
  amenities       String[]
  images          String[]

  approvedFromRequestId Int? @unique
  approvedFromRequest   SpaceRequest? @relation("SpaceApproval", fields: [approvedFromRequestId], references: [id])

  rooms Room[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Room {
  id          Int      @id @default(autoincrement())
  name        String
  capacity    Int
  workspaceId Int

  workspace    Workspace     @relation(fields: [workspaceId], references: [id])
  reservations Reservation[]
}

model Reservation {
  id        Int      @id @default(autoincrement())
  date      DateTime
  startTime DateTime
  endTime   DateTime
  userId    Int
  roomId    Int
  paid      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  room Room @relation(fields: [roomId], references: [id])
}

model Notification {
  id        Int       @id @default(autoincrement())
  title     String
  message   String
  type      String    @default("INFO")
  read      Boolean   @default(false)
  deletedAt DateTime?

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model SupportTicket {
  id          Int                 @id @default(autoincrement())
  title       String
  description String
  category    String
  priority    SupportPriority
  status      SupportTicketStatus @default(open)

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  messages SupportMessage[]

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?
}

model SupportMessage {
  id        Int     @id @default(autoincrement())
  message   String
  isSupport Boolean @default(false)

  ticketId Int
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId Int?
  author   User? @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
}

model SpaceRequest {
  id Int @id @default(autoincrement())

  ownerType     OwnerType
  ownerName     String
  ownerDocument String
  ownerEmail    String
  ownerPhone    String

  spaceName        String
  spaceType        String
  spaceDescription String

  zipCode      String
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String

  totalArea Int?
  capacity  Int?
  rooms     Int?

  pricePerHour   Float?
  pricePerDay    Float?
  pricePerMonth  Float?
  minimumBooking Int?
  additionalInfo String?

  amenities String[]
  images    String[]

  status SpaceRequestStatus @default(PENDING)
  
  approvedWorkspace Workspace? @relation("SpaceApproval")

  reviewedById Int?
  reviewedBy   User? @relation("ReviewedByAdmin", fields: [reviewedById], references: [id])

  reviewedAt DateTime?
  createdAt  DateTime  @default(now())
}
